name: Build WPF Project (Debug Trace)

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1️⃣ 拉代码
    - uses: actions/checkout@v3

    # 2️⃣ 计算 Git 信息（不走 GITHUB_ENV，直接用变量）
    - name: Get Git Info
      shell: pwsh
      run: |
        $gitRev = git rev-parse --short HEAD
        $commitMsg = git log -1 --pretty=%s   # ⚠️ 必须用 %s（单行）

        Write-Host "========== GIT INFO =========="
        Write-Host "GitRevision     = [$gitRev]"
        Write-Host "CommitMessage   = [$commitMsg]"
        Write-Host "================================"

        # 暂存到文件，给下一个 step 用（最稳）
        Set-Content gitrev.txt $gitRev
        Set-Content commitmsg.txt $commitMsg

    # 3️⃣ Build，并把值明确传给 MSBuild
    - name: Build with Git Metadata
      shell: pwsh
      run: |
        $gitRev = Get-Content gitrev.txt
        $commitMsg = Get-Content commitmsg.txt

        Write-Host "========== MSBUILD INPUT =========="
        Write-Host "GitRevision     = [$gitRev]"
        Write-Host "CommitMessage   = [$commitMsg]"
        Write-Host "=================================="

        dotnet build HostComputer.sln -c Release `
          /p:GitRevision="$gitRev" `
          /p:GitCommitMessage="$commitMsg" `
          /v:minimal

    # 4️⃣ 直接在 CI 中读取 exe，验证 AssemblyMetadata（终极确认）
    - name: Verify AssemblyMetadata in EXE
      shell: pwsh
      run: |
        $exe = "HostComputer/bin/Release/net8.0-windows/HostComputer.exe"

        if (!(Test-Path $exe)) {
          Write-Error "EXE not found: $exe"
          exit 1
        }

        Write-Host "========== ASSEMBLY METADATA =========="
        Add-Type -AssemblyName System.Reflection
        $asm = [System.Reflection.Assembly]::LoadFrom($exe)
        $meta = $asm.GetCustomAttributes([System.Reflection.AssemblyMetadataAttribute], $false)

        foreach ($m in $meta) {
          Write-Host "$($m.Key) = [$($m.Value)]"
        }
        Write-Host "======================================="
